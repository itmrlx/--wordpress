"use strict";var AmePluginVisibilityModule=function(){function e(t){var i=this,s=e._;this.actorSelector=new AmeActorSelector(AmeActors,t.isProVersion);var o=ko.observable(this.actorSelector.selectedActor);this.selectedActor=ko.computed({read:function(){return o()},write:function(e){i.actorSelector.setSelectedActor(e)}}),this.actorSelector.onChange(function(e){o(e)}),this.selectedActor(t.selectedActor),this.canRoleManagePlugins=t.canManagePlugins,this.isMultisite=t.isMultisite,this.grantAccessByDefault={},s.forEach(this.actorSelector.getVisibleActors(),function(e){i.grantAccessByDefault[e.id]=ko.observable(s.get(t.settings.grantAccessByDefault,e.id,i.canManagePlugins(e)))}),this.plugins=s.map(t.installedPlugins,function(e){return new AmePlugin(e,s.get(t.settings.plugins,e.fileName,{}),i)}),this.privilegedActors=[this.actorSelector.getCurrentUserActor()],this.isMultisite&&this.privilegedActors.push(AmeActors.getSuperAdmin()),this.areAllPluginsChecked=ko.computed({read:function(){return s.every(i.plugins,function(e){return i.isPluginVisible(e)})},write:function(e){if(null!==i.selectedActor()){var t=i.getGrantAccessByDefault(i.selectedActor());t(e)}s.forEach(i.plugins,function(t){i.setPluginVisibility(t,e)})}}),this.settingsData=ko.observable("")}return e.prototype.isPluginVisible=function(e){var t=this.selectedActor();if(null===t)return e.isVisibleByDefault();var i=this.getGrantAccessByDefault(t),s=e.getGrantObservable(t,e.isVisibleByDefault()&&i());return s()},e.prototype.setPluginVisibility=function(t,i){var s=this,o=this.selectedActor();if(null===o){t.isVisibleByDefault(i);var r=e._;r.forEach(this.actorSelector.getVisibleActors(),function(e){var o=t.getGrantObservable(e.id,i);o(!!s.canManagePlugins(e)&&(!!r.includes(s.privilegedActors,e)||i))})}else{var n=t.getGrantObservable(o,i);n(i)}},e.prototype.canManagePlugins=function(t){var i=this,s=e._;if(t instanceof AmeRole&&s.has(this.canRoleManagePlugins,t.name))return this.canRoleManagePlugins[t.name];if(t instanceof AmeSuperAdmin)return!0;if(t instanceof AmeUser){var o=!1;return s.forEach(t.roles,function(e){if(s.get(i.canRoleManagePlugins,e,!1))return o=!0,!1}),o||AmeActors.hasCap(t.id,"activate_plugins")}return!1},e.prototype.getGrantAccessByDefault=function(e){return this.grantAccessByDefault.hasOwnProperty(e)||(this.grantAccessByDefault[e]=ko.observable(this.canManagePlugins(AmeActors.getActor(e)))),this.grantAccessByDefault[e]},e.prototype.getSettings=function(){var t=e._,i={};return i.grantAccessByDefault=t.mapValues(this.grantAccessByDefault,function(e){return e()}),i.plugins={},t.forEach(this.plugins,function(e){i.plugins[e.fileName]={isVisibleByDefault:e.isVisibleByDefault(),grantAccess:t.mapValues(e.grantAccess,function(e){return e()})}}),i},e.prototype.saveChanges=function(){var t=this.getSettings(),i=e._,s=i.pluck(this.actorSelector.getVisibleActors(),"id");return i.forEach(t.plugins,function(e){e.grantAccess=i.pick(e.grantAccess,s)}),this.settingsData(jQuery.toJSON(t)),!0},e._=wsAmeLodash,e}(),AmePlugin=function(){function e(t,i,s){var o=this;this.name=e.stripAllTags(t.name),this.description=e.stripAllTags(t.description),this.fileName=t.fileName,this.isActive=t.isActive;var r=AmePluginVisibilityModule._;this.isVisibleByDefault=ko.observable(r.get(i,"isVisibleByDefault",!0));var n={};this.grantAccess=r.mapValues(r.get(i,"grantAccess",n),function(e){return ko.observable(e)}),this.isChecked=ko.computed({read:function(){return s.isPluginVisible(o)},write:function(e){return s.setPluginVisibility(o,e)}})}return e.prototype.getGrantObservable=function(e,t){return void 0===t&&(t=!0),this.grantAccess.hasOwnProperty(e)||(this.grantAccess[e]=ko.observable(t)),this.grantAccess[e]},e.stripAllTags=function(e){var t=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,i=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return e.replace(i,"").replace(t,"")},e}();jQuery(function(e){amePluginVisibility=new AmePluginVisibilityModule(wsPluginVisibilityData),ko.applyBindings(amePluginVisibility,document.getElementById("ame-plugin-visibility-editor")),e("#ame-pv-usage-notice").on("click",".notice-dismiss",function(){e.post(wsPluginVisibilityData.adminAjaxUrl,{action:"ws_ame_dismiss_pv_usage_notice",_ajax_nonce:wsPluginVisibilityData.dismissNoticeNonce})})});