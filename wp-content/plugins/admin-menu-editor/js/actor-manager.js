"use strict";var __extends=this&&this.__extends||function(e,t){function i(){this.constructor=e}for(var s in t)t.hasOwnProperty(s)&&(e[s]=t[s]);e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)},AmeBaseActor=function(){function e(e,t,i){this.displayName="[Error: No displayName set]",this.groupActors=[],this.actorTypeSpecificity=0,this.id=e,this.displayName=t,this.capabilities=i}return e.prototype.hasOwnCap=function(e){return this.capabilities.hasOwnProperty(e)?this.capabilities[e]:null},e.getActorSpecificity=function(e){var t=e.substring(0,e.indexOf(":")),i=0;switch(t){case"role":i=1;break;case"special":i=2;break;case"user":i=10;break;default:i=0}return i},e.prototype.toString=function(){return this.displayName+" ["+this.id+"]"},e}(),AmeRole=function(e){function t(t,i,s){e.call(this,"role:"+t,i,s),this.actorTypeSpecificity=1,this.name=t}return __extends(t,e),t.prototype.hasOwnCap=function(t){return t===this.name||e.prototype.hasOwnCap.call(this,t)},t}(AmeBaseActor),AmeUser=function(e){function t(t,i,s,o,r,n){void 0===r&&(r=!1),e.call(this,"user:"+t,i,s),this.userId=0,this.isSuperAdmin=!1,this.avatarHTML="",this.actorTypeSpecificity=10,this.userLogin=t,this.roles=o,this.isSuperAdmin=r,this.userId=n||0,this.isSuperAdmin&&this.groupActors.push(AmeSuperAdmin.permanentActorId);for(var l=0;l<this.roles.length;l++)this.groupActors.push("role:"+this.roles[l])}return __extends(t,e),t.createFromProperties=function(e){var i=new t(e.user_login,e.display_name,e.capabilities,e.roles,e.is_super_admin,e.hasOwnProperty("id")?e.id:null);return e.avatar_html&&(i.avatarHTML=e.avatar_html),i},t}(AmeBaseActor),AmeSuperAdmin=function(e){function t(){e.call(this,t.permanentActorId,"Super Admin",{}),this.actorTypeSpecificity=2}return __extends(t,e),t.prototype.hasOwnCap=function(e){return"do_not_allow"!==e},t.permanentActorId="special:super_admin",t}(AmeBaseActor),AmeActorManager=function(){function e(t,i,s){var o=this;void 0===s&&(s=!1),this.roles={},this.users={},this.grantedCapabilities={},this.isMultisite=!1,this.suggestedCapabilities=[],this.isMultisite=!!s,e._.forEach(t,function(e,t){var i=new AmeRole(t,e.name,e.capabilities);o.roles[i.name]=i}),e._.forEach(i,function(e){var t=AmeUser.createFromProperties(e);o.users[t.userLogin]=t}),this.isMultisite&&(this.superAdmin=new AmeSuperAdmin)}return e.prototype.actorCanAccess=function(e,t,i){return void 0===i&&(i=null),t.hasOwnProperty(e)?t[e]:null===i||this.hasCap(e,i,t)},e.prototype.getActor=function(e){if(e===AmeSuperAdmin.permanentActorId)return this.superAdmin;var t=e.indexOf(":"),i=e.substring(0,t),s=e.substring(t+1);if("role"===i)return this.roles.hasOwnProperty(s)?this.roles[s]:null;if("user"===i)return this.users.hasOwnProperty(s)?this.users[s]:null;throw{name:"InvalidActorException",message:"There is no actor with that ID, or the ID is invalid.",value:e}},e.prototype.actorExists=function(e){try{return null!==this.getActor(e)}catch(e){if(e.hasOwnProperty("name")&&"InvalidActorException"===e.name)return!1;throw e}},e.prototype.hasCap=function(e,t,i){return i=i||{},this.actorHasCap(e,t,[i,this.grantedCapabilities])},e.prototype.hasCapByDefault=function(e,t){return this.actorHasCap(e,t)},e.prototype.actorHasCap=function(t,i,s){if("exist"===i)return!0;if(i=e.mapMetaCap(i),s)for(var o,r=null,n=s.length,l=0;l<n;l++)if(s[l].hasOwnProperty(t)){if(o=s[l][t],"boolean"==typeof o)return o;if(o.hasOwnProperty(i))return r=o[i],"boolean"==typeof r?r:r[0]}var a=this.getActor(t),d=a.hasOwnCap(i);if(null!==d)return d;if(a instanceof AmeUser){if(a.isSuperAdmin)return this.actorHasCap("special:super_admin",i,s);r=!1;for(var c=0;c<a.roles.length;c++)r=r||this.actorHasCap("role:"+a.roles[c],i,s);return r}return!1},e.mapMetaCap=function(e){return"customize"===e?"edit_theme_options":"delete_site"===e?"manage_options":e},e.prototype.getRoles=function(){return this.roles},e.prototype.roleExists=function(e){return this.roles.hasOwnProperty(e)},e.prototype.getSuperAdmin=function(){return this.superAdmin},e.prototype.getUsers=function(){return this.users},e.prototype.getUser=function(e){return this.users.hasOwnProperty(e)?this.users[e]:null},e.prototype.addUsers=function(t){var i=this;e._.forEach(t,function(e){i.users[e.userLogin]=e})},e.prototype.getGroupActorsFor=function(e){return this.users[e].groupActors},e.prototype.setGrantedCapabilities=function(t){this.grantedCapabilities=e._.cloneDeep(t)},e.prototype.getGrantedCapabilities=function(){return this.grantedCapabilities},e.prototype.setCap=function(t,i,s,o,r){e.setCapInContext(this.grantedCapabilities,t,i,s,o,r)},e.setCapInContext=function(t,i,s,o,r,n){s=e.mapMetaCap(s);var l=r?[o,r,n||null]:o;e._.set(t,[i,s],l)},e.prototype.resetCap=function(t,i){e.resetCapInContext(this.grantedCapabilities,t,i)},e.resetCapInContext=function(t,i,s){s=e.mapMetaCap(s),e._.has(t,[i,s])&&delete t[i][s]},e.prototype.pruneGrantedUserCapabilities=function(){var t=this,i=e._,s=i.cloneDeep(this.grantedCapabilities),o=[s],r=i(s).keys().filter(function(e){var i=t.getActor(e);return null!==i&&i instanceof AmeUser}).value();return i.forEach(r,function(e){i.forEach(i.keys(s[e]),function(r){var n=s[e][r];delete s[e][r];var l=i.isArray(n)?n[0]:n,a=t.actorHasCap(e,r,o);l!==a&&(s[e][r]=n)})}),this.setGrantedCapabilities(s),s},e.compareActorSpecificity=function(e,t){var i=AmeBaseActor.getActorSpecificity(e)-AmeBaseActor.getActorSpecificity(t);return 0!==i&&(i=i>0?1:-1),i},e.prototype.generateCapabilitySuggestions=function(t){var i=e._,s=i.memoize(function(e){var s=i.reduce(e.capabilities,function(e,s,o){return s&&e.push({capability:o,power:i.get(t,[o],0)}),e},[]);return s=i.sortBy(s,function(e){return-e.power})}),o=i.values(this.getRoles()).sort(function(e,t){for(var i=s(e),o=s(t),r=0,n=Math.min(i.length,o.length);r<n;r++){var l=o[r].power-i[r].power;if(0!==l)return l}var a=o.length-i.length;return 0!==a?a:e.displayName>t.displayName?1:e.displayName<t.displayName?-1:0}),r=["manage_network_options","install_plugins","edit_plugins","delete_users","manage_options","switch_themes","edit_others_pages","edit_others_posts","edit_pages","unfiltered_html","publish_posts","edit_posts","read"],n=i(i.range(0,10)).map(function(e){return"level_"+e}).value();n.push("edit_files");for(var l=function(e,t,s){var o=function(e){return i.keys(i.pick(e.capabilities,i.identity))},l=i.intersection.apply(i,i.map(t,o)),a=i.union.apply(i,i.map(s,o)),d=i.without.apply(i,[l].concat(a).concat(n)),c=i.intersection(r,d);return c.length>0?c[0]:d.length>0?d[0]:null},a=[],d=0;d<o.length;d++){var c=o[d],u=l(r,i.slice(o,0,d+1),i.slice(o,d+1,o.length));a.push({role:c,capability:u})}for(var p=null,d=a.length-1;d>=0;d--)null===a[d].capability?a[d].capability=p?p:"exist":p=a[d].capability;this.suggestedCapabilities=a},e.prototype.getSuggestedCapabilities=function(){return this.suggestedCapabilities},e._=wsAmeLodash,e}();"undefined"!=typeof wsAmeActorData&&(AmeActors=new AmeActorManager(wsAmeActorData.roles,wsAmeActorData.users,wsAmeActorData.isMultisite),"undefined"!=typeof wsAmeActorData.capPower&&AmeActors.generateCapabilitySuggestions(wsAmeActorData.capPower));